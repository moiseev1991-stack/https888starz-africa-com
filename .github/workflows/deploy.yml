# Deploy static HTML site to Beget.
# Только содержимое dist/ (сайт + .htaccess). Никакого .git, .github, node_modules, scripts.
# Error 521 (Web server is down) = Cloudflare не достучался до Beget → см. docs/DEPLOY_521_CHECKLIST.md
name: Deploy to Beget
on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Chromium
        run: npx playwright install chromium

      # КРАУЛИТЬ ТОТ ЖЕ САЙТ, НА КОТОРЫЙ ДЕПЛОИМ: иначе меню/страницы с другого домена (Africa) попадают на Egypt — ссылки и страницы ломаются.
      - name: Build static site
        run: npm run build:live
        env:
          CRAWL_BASE_URL: "https://888starz-africa.com"
          STATIC_BASE_URL: "https://888starzeg-egypt.com"
          STATIC_OUT_DIR: "dist"

      - name: Prepare deploy folder
        id: prepare
        run: |
          set -e
          mkdir -p deploy
          cp -r dist/. deploy/
          if [ -f "dist/index" ] && [ ! -f "deploy/index.html" ]; then
            cp dist/index deploy/index.html
          fi
          if [ ! -f "deploy/index.html" ]; then
            echo "::error::deploy/index.html is missing. Cannot deploy."
            exit 1
          fi
          if [ ! -f "deploy/.htaccess" ]; then
            echo "::warning::deploy/.htaccess missing (rewrite/cache may not work on Beget)"
          fi
          echo "Deploy folder ready. Top-level files:"
          ls -la deploy/ | head -25

      - name: Create deploy archive
        run: tar czf deploy.tar.gz -C deploy .

      - name: Clear target on Beget
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            set -e
            T="/home/s/smirno34/888starzeg-egypt.com/public_html"
            mkdir -p "$T"
            find "$T" -mindepth 1 -delete

      - name: Upload archive to Beget
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          source: "deploy.tar.gz"
          target: "/home/s/smirno34/888starzeg-egypt.com/public_html"

      - name: Extract and cleanup on Beget
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script: |
            set -e
            T="/home/s/smirno34/888starzeg-egypt.com/public_html"
            cd "$T"
            if [ -d "deploy.tar.gz" ]; then
              echo "::error::deploy.tar.gz is a directory (old SCP bug). Removing and failing."
              rm -rf deploy.tar.gz
              exit 1
            fi
            if [ ! -f "deploy.tar.gz" ]; then
              echo "::error::deploy.tar.gz not found in $T"
              ls -la "$T" || true
              exit 1
            fi
            echo "Extracting deploy.tar.gz..."
            tar xzf deploy.tar.gz
            echo "Removing deploy.tar.gz..."
            rm -f deploy.tar.gz
            echo "Deployment complete. Files in $T:"
            ls -la "$T" | head -20
      # Если после деплоя сайт не открывается (521): см. docs/DEPLOY_521_CHECKLIST.md
