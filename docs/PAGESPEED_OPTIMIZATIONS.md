# PageSpeed Optimizations

## Выполненные оптимизации

### 1. Удаление дублирующегося jQuery ✅
**Проблема:** Загружались две версии jQuery (3.7.1 локально и 3.6.4 с CDN), что увеличивало время загрузки на ~1350ms.

**Решение:**
- Удален jQuery из `footer.php` (строка 9)
- Оставлен только один jQuery, загружаемый через WordPress `wp_enqueue_script`
- Скрипт `optimize-html-performance.js` автоматически удаляет дубликаты при экспорте

**Ожидаемая экономия:** ~1350ms

### 2. Оптимизация загрузки скриптов (defer/async) ✅
**Проблема:** Скрипты блокировали рендеринг страницы.

**Решение:**
- Добавлен `defer` для OwlCarousel и Fancybox в `footer.php`
- Скрипт оптимизации автоматически добавляет `defer` для всех не-критических скриптов
- jQuery остается синхронным (нужен для инициализации)

**Ожидаемая экономия:** ~500-700ms

### 3. Оптимизация загрузки CSS ✅
**Проблема:** CSS файлы (Font Awesome, plugins.min.css, fancybox) блокировали рендеринг.

**Решение:**
- Не-критические CSS (Font Awesome, plugins.min.css, fancybox, flexy-breadcrumb) теперь загружаются асинхронно через `preload` + `onload`
- Критические CSS остаются синхронными

**Ожидаемая экономия:** ~700ms

### 4. Font-display: swap для Font Awesome ✅
**Проблема:** Font Awesome шрифт блокировал отображение текста, ожидаемая экономия 240ms.

**Решение:**
- Добавлен `font-display: swap` для всех `@font-face` правил в CSS файлах
- Добавлен inline стиль в HTML для Font Awesome

**Ожидаемая экономия:** 240ms

### 5. Улучшение кеширования ✅
**Проблема:** Статические ресурсы кешировались только на 7 дней, ожидаемая экономия 82 KiB на повторных визитах.

**Решение:**
- Создан `.htaccess` с кешированием на 1 год для:
  - CSS и JavaScript файлы
  - Шрифты (woff2, woff, ttf, eot)
  - Изображения (webp, png, jpeg, gif, svg)
- HTML кешируется на 1 час (для обновлений контента)
- Добавлены Cache-Control headers с `immutable` для статических ресурсов

**Ожидаемая экономия:** 82 KiB на повторных визитах

### 6. Удаление jQuery Migrate ✅
**Проблема:** jQuery Migrate добавлял лишние 5.4 KiB и 700ms загрузки.

**Решение:**
- Автоматически удаляется скриптом оптимизации (обычно не нужен для современных сайтов)

**Ожидаемая экономия:** ~700ms + 5.4 KiB

## Общая ожидаемая экономия

- **Время загрузки:** ~3500-4000ms (3.5-4 секунды)
- **Размер данных:** ~87 KiB на повторных визитах
- **Render-blocking ресурсы:** Устранены для не-критических CSS/JS

## Файлы изменений

1. `wp-content/themes/zento/footer.php` - удален дублирующийся jQuery, добавлен defer
2. `scripts/optimize-html-performance.js` - новый скрипт для post-processing оптимизации
3. `scripts/copy-wp-assets.js` - добавлено копирование .htaccess
4. `package.json` - добавлен скрипт оптимизации в `build:live`
5. `dist/.htaccess` - конфигурация кеширования (копируется автоматически)

## Как это работает

После экспорта статического сайта (`npm run build:live`), автоматически запускается `optimize-html-performance.js`, который:

1. Обрабатывает все HTML файлы в `dist/`
2. Удаляет дублирующиеся jQuery скрипты
3. Добавляет `defer` для не-критических скриптов
4. Оптимизирует загрузку CSS через `preload`
5. Добавляет `font-display: swap` для шрифтов
6. Обрабатывает CSS файлы для добавления `font-display: swap`

## Дополнительные правки (коммит по скриншотам PageSpeed)

- **Порядок jQuery:** оставляем в документе только первый по порядку jQuery, остальные удаляем (чтобы не было «$ is not a function»).
- **Без defer для зависимых скриптов:** defer добавляется только для owl/fancybox и Yandex Metrica; scripts.min.js и остальные не трогаем, чтобы не ломать порядок загрузки.
- **Удаление проблемных скриптов:** из статического HTML убираются `wp-emoji-release.min.js` и скрипт `cdn-cgi/rum` (ошибки в консоли на статике).
- **Google Fonts:** подключаются через preload + onload, чтобы не блокировать рендер.
- **Yandex Metrica:** к скрипту добавлен `defer`.
- **header.php:** убран дублирующий `<script src="https://code.jquery.com/jquery-3.6.4.min.js">`, jQuery идёт только из `wp_head()`.

## Дополнительные рекомендации (не реализовано)

### Forced Layout (115ms)
**Проблема:** JavaScript запрашивает геометрические свойства после изменения DOM.

**Рекомендации:**
- Найти места в коде где происходит чтение `offsetWidth`, `offsetHeight`, `getBoundingClientRect()` сразу после изменения DOM
- Батчить чтения и записи DOM (сначала все записи, потом все чтения)
- Использовать `requestAnimationFrame` для отложенных чтений

**Где искать:**
- `wp-content/themes/zento/assets/js/functions.js`
- `wp-content/themes/zento/assets/js/shortcodes.js`
- Скрипты в `footer.php`

### Критический путь запросов (1624ms)
**Проблема:** Font Awesome webfont (76 KiB) является самым большим узким местом.

**Рекомендации:**
- Рассмотреть использование только необходимых иконок Font Awesome вместо полного набора
- Использовать SVG иконки вместо шрифтовых
- Предзагружать критический шрифт через `<link rel="preload">`

### Yandex Metrica (84 KiB, кеш 1 час)
**Проблема:** Третий сторонний ресурс с коротким кешем.

**Рекомендации:**
- Это ограничение со стороны Yandex, прямого контроля нет
- Можно рассмотреть альтернативные аналитические решения с лучшим кешированием

## Проверка результатов

После деплоя проверьте:

1. **Google PageSpeed Insights:** https://pagespeed.web.dev/
2. **GTmetrix:** https://gtmetrix.com/
3. **WebPageTest:** https://www.webpagetest.org/

Ожидаемые улучшения:
- ✅ Render-blocking resources: должно быть меньше
- ✅ Efficient cache policy: должно быть зеленым
- ✅ Font display: должно быть "swap" или "optional"
- ✅ Duplicate jQuery: должно быть удалено
